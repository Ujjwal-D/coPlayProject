<!-- You are not expected to read or edit this HTML5 -->
<DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>coPlay</title>
    <style>
      canvas {
        border: 1px solid black;
      }

      html {
        /*background-image: linear-gradient(-45deg, rgb(139, 139, 139), rgba(153, 153, 153, 0.576));
    background-size: 100px 100px;*/
        background-color: grey;
      }

      body {
        /*width:  1000px;*/
        margin: auto;
        font-family: 'Ruluko', sans-serif;
        color: white;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        font-family: 'Ruluko', sans-serif;
        color: white;
        height: 100%;
        background: none;
        background-attachment: fixed;
        background-size: cover;
        background-repeat: no-repeat;
        position: relative;
      }

      /* Full-page background image */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image:
          linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
          url('https://www.transparenttextures.com/patterns/brick-wall.png');
        background-repeat: repeat;
        background-size: auto;
        z-index: -1;
      }

      header,
      h1,
      h2 {
        color: white;
        font-family: 'Shrikhand', cursive;
        font-size: 30px;
        text-align: center;
        text-shadow: 5px 5px rgba(0, 0, 0, 0.576);
      }

      .tracker {
        position: relative;
        /*left: 550px;*/
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        background-color: #0B3303;
        width: 400px;
        border: groove rgb(255, 255, 255) 5px;
        border-radius: 20px;
      }

      .numDisks {
        background-color: #0B3303;
        color: white;
        margin: 25px 25px;
        border: none;
      }

      .board {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        height: 550px;
        max-width: 800px;
        background-color: rgba(0, 0, 0, 0.4);
        /* ⬅️ DARK translucent background */
        position: relative;
        left: 100px;
        border: 2px solid #ffffff20;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        padding: 20px;
      }

      .tower {
        width: 260px;
        height: 500px;
        background-image: linear-gradient(90deg,
            rgba(0, 0, 0, 0) 115px,
            #9f834d 115px,
            #9f834d 145px,
            rgba(0, 0, 0, 0.5) 150px,
            rgba(0, 0, 0, 0) 150px);
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        margin: 10px 0 -10px 0;
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .tower::after {
        content: "";
        position: absolute;
        bottom: -15px;
        width: 100%;
        height: 20px;
        background-color: black;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        z-index: -1;
      }

      #chat {
        width: 80%;
        height: 70px;
        border: 1px solid #ccc;
        background: rgba(255, 255, 255, 0.1);
        /* Semi-transparent */
        color: rgba(255, 255, 255, 0.7);
        /* Dim text */
        padding: 5px;
        overflow-y: scroll;
        white-space: pre-line;
        margin-bottom: 10px;

        opacity: 0;
        transition: opacity 1s ease;
        visibility: hidden;
      }

      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        /* Left-aligns everything inside */
        margin-left: 20px;
        /* Optional: Adds space from the left edge */
      }

      .chat-title {
        font-size: 24px;
        text-shadow: 2px 2px rgba(0, 0, 0, 0.3);
        margin-bottom: 5px;
        text-align: left;
      }

      #chatInput {
        padding: 8px 12px;
        width: 250px;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      #chatInput:focus {
        border-color: #00cc66;
        box-shadow: 0 0 5px rgba(0, 204, 102, 0.5);
      }

      button {
        padding: 8px 16px;
        margin-top: 6px;
        margin-left: 4px;
        font-size: 14px;
        background-color: #00cc66;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #00994d;
      }

      #pingStatus {
        font-size: 12px;
        font-style: italic;
        color: lightgreen;
        margin-bottom: 10px;
        text-align: right;
      }

      @media (max-width: 768px) {
        .board {
          flex-direction: column;
          left: 0;
          height: auto;
        }

        .tower {
          margin-bottom: 20px;
        }

        .tracker {
          flex-direction: column;
          width: 100%;
          align-items: center;
        }
      }

      #counter,
      #minimum,
      .numdisks {
        font-family: 'Roboto Mono', monospace;
        text-shadow: 2px 2px rgb(114, 113, 113);
        font-size: 20px;
        text-align: center;
        margin: 0 0 4px 0;
      }

      #modal {
        background-color: rgba(0, 0, 0, .4);
        position: fixed;
        top: 0;
        left: 0;
        /*height: 100%;
	width: 100%;*/
        z-index: 1;
        overflow: auto;
        display: none;
      }

      #modal-textbox {
        background-color: #0B3303;
        width: 350px;
        border-radius: 2px;
        margin: 300px auto;
        line-height: 1.2;
        text-align: center;
        padding: 5px 25px;
        border: groove rgb(255, 255, 255) 5px;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.2);
        border-radius: 20px;
      }

      #winner {
        font-size: 25px;
      }

      h1 {
        font-family: 'Shrikhand', cursive;
        font-size: 36px;
        color: #ffffff;
        text-align: center;
        margin: 10px 0;
        letter-spacing: 1px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      }

      h2 {
        color: white;
        font-family: 'Shrikhand', cursive;
        font-size: 30px;
        text-align: center;
        text-shadow: 5px 5px rgba(0, 0, 0, 0.576);
      }

      li {
        list-style-type: none;
        margin: 5px 15px;
      }

      .rules {
        font-size: 20px;
        text-shadow: 2px 2px rgba(255, 255, 255, 0.3);
        background-color: #0B3303;
        border: groove rgb(255, 255, 255) 5px;
        border-radius: 20px;
        padding: 5px 15px;
      }

      footer {
        background-color: rgba(11, 51, 3, 0.2)
      }

      .disk {
        border: solid black 1px;
        border-radius: 25px;
        height: 40px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 3px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease;
      }

      .disk.glow {
        outline: 3px solid #00ffff;
        /* Aqua glowing edge */
        box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
        border-width: 1px !important;
        /* Reset any large border */
      }

      .disk:active {
        transform: none
      }

      #disk1 {
        width: 260px;
        background-color: green;
      }

      #disk2 {
        width: 235px;
        background-color: yellow;
      }

      #disk3 {
        width: 210px;
        background-color: teal;
      }

      #disk4 {
        width: 185px;
        background-color: pink;
      }

      #disk5 {
        width: 160px;
        background-color: skyblue;
      }

      #disk6 {
        width: 135px;
        background-color: rebeccapurple;
      }

      #disk7 {
        width: 110px;
        background-color: red;
      }

      #disk8 {
        width: 85px;
        background-color: orange;
      }

      .reset {
        text-align: center;
        margin: 10px auto;
        padding: 8px 18px;
        background-color: #007a3d;
        ;
        border: groove rgb(255, 255, 255) 1px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        width: 100px;
        color: white;
        font-weight: bold;
        position: relative;
        left: 450px;
        transition: background-color 0.2s ease;
        margin-top: 20px;
      }

      .reset:hover {
        background-color: #00994d;
      }

      .help-container {
        position: absolute;
        top: 20px;
        right: 30px;
        z-index: 10;
      }

      #helpBtn {
        padding: 12px 20px;
        margin-top: 100px;
        background-color: #00cc66;
        color: white;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Shrikhand', cursive;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      #helpBtn:hover {
        background-color: #00a658;
        transform: scale(1.05);
      }



      .help-modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.85);
        /* Increased darkness */
        backdrop-filter: blur(4px);
        /* Add blur behind popup */
      }

      .help-content {
        background-color: #1b1b1b;
        /* Darker content box */
        margin: 10% auto;
        padding: 25px 35px;
        border: 2px solid white;
        border-radius: 20px;
        width: 60%;
        color: white;
        font-size: 18px;
        text-shadow: 1px 1px rgba(0, 0, 0, 0.6);
        font-family: 'Ruluko', sans-serif;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        /* Stronger glow */
      }

      .close-btn {
        position: absolute;
        top: 15px;
        left: 20px;
        font-size: 30px;
        font-weight: bold;
        color: white;
        background-color: #f44336;
        border: 2px solid white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        text-align: center;
        line-height: 36px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      .close-btn:hover {
        background-color: #d32f2f;
        transform: scale(1.1);
      }

      #shutdownBtn {
        display: inline-block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Ruluko', sans-serif;
        background-color: #ff4c4c;
        color: white;
        border: 2px solid white;
        border-radius: 10px;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      #shutdownBtn:hover {
        background-color: #cc0000;
        transform: scale(1.05);
      }
    </style>

    <script>
      let lastUpdateTime = Date.now();

      function updatePingDisplay() {
        const secondsAgo = Math.floor((Date.now() - lastUpdateTime) / 1000);
        document.getElementById('pingStatus').innerText = `Last update: ${secondsAgo}s ago`;
      }
      function resetPing() {
        lastUpdateTime = Date.now(); // Reset timer
      }


      function postMessage() {
        const msgBox = document.getElementById("chatInput");
        const msg = msgBox.value.trim();
        if (!msg) {
          alert("Message cannot be empty");
          return;
        }
        fetch('/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/text' },
          body: btoa(msg)
        })
          .then(response => response.text())
          .then(data => console.log("Message sent:", data))
          .catch(err => console.error("Error sending message:", err));

        msgBox.value = "";
        resetPing(); //Reset timer on message send
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("chatInput").addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            postMessage();
          }
        });
        setInterval(updatePingDisplay, 1000);
      });

      let chatHistory = ""; // Store chat history locally

      function requestReset() {
        fetch("/reset_request", { method: "GET" })
          .then(res => console.log("Reset _request sent:", res.status))
          .catch(err => console.error("Error requesting reset:", err));
        resetPing(); // Reset timer on reset request
      }

      setInterval(function () {
        fetch('/update', { method: 'GET' })
          .then(response => response.json())
          .then(messages => {
            const chat = document.getElementById('chat');
            let newMessageAdded = false;

            for (const data of messages) {
              if ('message' in data) {
                const msg = data['message'];

                chatHistory += msg + "\n";
                newMessageAdded = true;

              } else if ('tower' in data) {
                const tower = JSON.parse(data['tower']);
                if (tower == 1) actions(tower1);
                else if (tower == 2) actions(tower2);
                else if (tower == 3) actions(tower3);
              }
              else if ('reset_request' in data) {
                // data.origin tells us who asked. e.g. 5000 or 5002.
                const otherPort = data.origin;
                const myPort = window.location.port;
                if (otherPort !== parseInt(myPort)) {
                  // If we are NOT the requester, prompt the user:
                  const confirmReset = confirm(
                    "Peer on port " + otherPort + " wants to reset the game.\n" +
                    "Do you approve?"
                  );
                  if (confirmReset) {
                    // If they click “OK”, tell our server to broadcast the real reset:
                    fetch("/reset_confirm", { method: "GET" })
                      .then(res => console.log("Reset confirmed:", res.status))
                      .catch(err => console.error("Error confirming reset:", err));
                  } else {
                    // If they click “Cancel”, broadcast a decline (optional):
                    fetch("/reset_decline", { method: "GET" })
                      .then(res => console.log("Reset declined:", res.status))
                      .catch(err => console.error("Error declining reset:", err));
                  }
                } else {
                  // If otherPort === myPort, *I* was the one who requested.
                  // You *could* show “Waiting for peer to confirm…” in the UI here.
                  console.log("Reset request sent; waiting for peer to confirm...");
                }
              }
              // ── 4) NEW: the “real” reset has been approved ──
              else if ('reset' in data) {
                // Both peers call newGame()
                newGame();
              }
              // ── 5) OPTIONAL: reset was explicitly declined ──
              else if ('reset_decline' in data) {
                const otherPort = data.origin;
                const myPort = window.location.port;
                if (otherPort !== parseInt(myPort)) {
                  // If someone else just declined, and that someone ≠ me,
                  // then I must be the original requester:
                  alert("Peer on port " + otherPort + " declined the reset. Game continues.");
                }
              }
            }

            chat.innerText = chatHistory; // Always restore full chat
            chat.scrollTop = chat.scrollHeight;

            if (newMessageAdded) {
              chat.innerText = chatHistory; // Restore full chat
              chat.scrollTop = chat.scrollHeight;

              chat.style.opacity = 1;
              chat.style.visibility = 'visible';

              // Always reset the fade-out timer
              clearTimeout(window.chatTimeout);
              window.chatTimeout = setTimeout(() => {
                chat.style.opacity = 0;
                chat.style.visibility = 'hidden';
              }, 4000);
            }
            updatePingDisplay();
          })
          .catch(err => console.error("Polling error:", err));
      }, 100);
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
  </head>

  <body>
    <h1>WebApp</h1>
    <h1>Tower of Hanoi</h1>

    <!-- How to Play Button and Modal -->
    <div class="help-container">
      <button id="helpBtn">How to Play</button>
    </div>

    <div id="helpModal" class="help-modal">
      <div class="help-modal-content">
        <span class="close-btn">&times;</span>
        <h2>How to Play</h2>
        <p>The objective of Tower of Hanoi is to move the disks from the tower on the left to the tower on the right.
          There are 3 simple rules:</p>
        <ul>
          <li>Only one disk can be moved at a time</li>
          <li>Each move consists of moving the top disk from one tower to the top of another tower, or an empty tower
          </li>
          <li>No disk may be placed on top of a smaller disk</li>
        </ul>
      </div>
    </div>

    <div class="chat-container">
      <h1 class="chat-title">Chat</h1>
      <div id="chat"></div>
      <input type="text" id="chatInput" placeholder="Type here">
      <button onclick="postMessage()">Post</button>
      <div id="pingStatus">Last update: 0s ago</div>
    </div>


    <script>
      function serializeMouseEvent(event) {
        return JSON.stringify({
          clientX: event.clientX,
          clientY: event.clientY,
        });
      }
      canvas.addEventListener('mousedown', startPosition);
      canvas.addEventListener('mouseup', endPosition);
      canvas.addEventListener('mousemove', draw);
    </script>
    <!--https://raw.githubusercontent.com/DaveSchuetz/Tower-of-Hanoi/refs/heads/master/index.html-->
    <!--DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Tower of Hanoi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Ruluko|Shrikhand" rel="stylesheet" /-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>

    <!--/head>
<body>
    <header-->
    <!--HEader that has the title of the page  -->

    <!--/header-->

    <div class="tracker">
      <p>Choose Disks</br>
        <select id="drop" class="numDisks" onchange="newGame()">
          <option id="d3" selected>3</option>
          <option id="d4">4</option>
          <option id="d5">5</option>
          <option id="d6">6</option>
          <option id="d7">7</option>
          <option id="d8">8</option>
        </select>
      </p>

      <!-- Counter at the top of the page also a portion that tells the minimum amount of moves -->
      <div>
        <p>Moves made</p>
        <div id="counter">0</div>
      </div>
      <div>
        <p>Minimum moves to solve</p>
        <div id="minimum">0</div>
      </div>
    </div>
    <h2>Game</h2>
    <div=id="modal">
      <div id="modal-textbox">
        <h2>Congratulations</h2>
        <!-- Paragraph added by JS -->
      </div>
    </div>
    <div class="board">
      <!-- The game board will need to have three towers that the disks can move around -->
      <div class="tower" id="first">

      </div>
      <div class="tower" id="second">

      </div>
      <div class="tower" id="third">

      </div>
    </div>
    <!-- reset button -->
    <button class="reset" onclick="requestReset()">Reset</button>

    <footer>
      <!-- A footer for links and signature -->
      <h5>Created by Dave Schuetz 2018</h5>
    </footer>

    <!--script src="main.js"></script>-->
    <script>
      // Help modal logic
      const helpBtn = document.getElementById("helpBtn");
      const helpModal = document.getElementById("helpModal");
      const closeBtn = document.querySelector(".close-btn");

      helpBtn.onclick = () => helpModal.style.display = "block";
      closeBtn.onclick = () => helpModal.style.display = "none";
      window.onclick = (e) => {
        if (e.target === helpModal) helpModal.style.display = "none";
      };
    </script>
  </body>
  <!--</html-->
  <script>
    // setting the towers and disk vars

    const tower1 = document.querySelector('#first') // tower 1
    const tower2 = document.querySelector('#second') // tower 2
    const tower3 = document.querySelector('#third') // tower 3
    let diskSelector = 0
    let minMoves = 0
    let counter = 0

    //Click event to show highlighted item variable needed to hold a true false value
    let active = false

    //Creating using DOM elements
    function build() {
      const diskDrop = document.getElementById('drop')
      diskSelector = diskDrop.options[diskDrop.selectedIndex].value
      for (i = 1; i <= diskSelector; i++) {
        // for loop to build the disks
        let diskDiv = document.createElement('div')
        diskDiv.id = 'disk' + i
        diskDiv.className = 'disk'
        tower1.appendChild(diskDiv)
      }
      minMoves = 2 ** diskSelector - 1
      document.getElementById('minimum').textContent = minMoves
    } build()

    let actions = function (ths) {
      if (active === false && ths.childElementCount === 0) {
        return;
      } else if (active === ths.lastChild) {
        // Deselecting the same disk
        ths.lastChild.classList.remove('glow');
        active = false;
      } else if (active === false) {
        // First selection
        ths.lastChild.classList.add('glow');
        active = ths.lastChild;
      } else if (active.offsetWidth < ths.lastChild.offsetWidth || ths.childElementCount === 0) {
        // Valid move to another tower
        active.classList.remove('glow');
        ths.appendChild(active);
        counter += 1;
        document.getElementById('counter').textContent = counter;
        winner();
        active = false;
      } else {
        // Invalid move
        active.classList.remove('glow'); 
        active = false;
      }
    };
    const tower_click_url = "/tower";
    function intercept_actions(tower) {
      url = tower_click_url + "?tower=" + tower
      fetch(url, { method: 'GET' })
      resetPing();
    }
    function intercept_actions1() {
      intercept_actions(1)
      //actions(tower1)
    }
    function intercept_actions2() {
      intercept_actions(2)
      //actions(tower2)
    }
    function intercept_actions3() {
      intercept_actions(3)
      console.log("tower3")
      //actions(tower3)
    }



    //The listeners are on the parents
    tower1.addEventListener('click', intercept_actions1)
    tower2.addEventListener('click', intercept_actions2)
    tower3.addEventListener('click', intercept_actions3)
    //winner alert
    function winner() {
      if (tower3.childElementCount == diskSelector) {
        const $modal = $('#modal')
        const $endGame = $('#modal-textbox')
        $modal.css('display', 'block')
        let para = document.createElement('p')
        para.id = 'winner'
        $endGame.append(para)
        counter === minMoves ? $('#winner').text(`You cleared the tower in ${counter} moves!! That is the fewest possible with ${diskSelector} disks.`) : $('#winner').text(`You cleared the tower in ${counter} moves! Try to do it again in fewer moves. The fewest to solve ${diskSelector} disks is ${minMoves} moves.`)
        const closeModal = () => {
          $modal.css('display', 'none')
        }
        $modal.on('click', closeModal)
        tower3.removeEventListener('click', intercept_actions3)
      }
    }

    function newGame() {
      $('.disk').remove()
      active = false
      counter = 0
      document.getElementById('counter').textContent = counter
      build()

      tower3.addEventListener('click', intercept_actions3)
    }
  </script>

  <a href='/shutdown' id="shutdownBtn">Shutdown</a>